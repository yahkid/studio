
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin or specific roles
    function isRole(role) {
      return request.auth.token.role == role || request.auth.token.role == 'admin';
    }
    
    // Anyone can read public content like leadership profiles, published events, courses and testimonials.
    // Only admins can write to this content.
    match /leadership/{leaderId} {
      allow read: if true;
      allow write: if isRole('admin');
    }
    
    match /events/{eventId} {
      allow read: if true;
      allow write: if isRole('admin') || isRole('content_editor');
    }

    match /courses/{courseId} {
      allow read: if true;
      allow write: if isRole('admin') || isRole('content_editor');
    }

    match /published_testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isRole('admin');
    }

    // Authenticated users can create their own submissions (decisions, testimonies, etc.).
    // Only specific roles can read/write them afterwards.
    match /decisions/{decisionId} {
      allow create: if request.auth != null;
      // Only pastoral care and admins can read or update decision documents.
      allow read, update, delete: if isRole('pastoral_care');
    }

    match /user_testimonies/{testimonyId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      // Admins can read/update testimonies during the review process.
      allow read, update, delete: if isRole('admin');
    }
    
    // Users can only read and write their own course progress.
    match /user_course_progress/{progressId} {
      allow read, write: if request.auth.uid == resource.data.user_id;
      allow create: if request.auth.uid == request.resource.data.user_id;
    }

    // Form submissions are write-only for any user. No one should read them directly
    // except via a secure admin/backend process.
    match /lead_magnet_signups/{docId} {
      allow read: if isRole('admin'); // Admins can see signups
      allow create: if true; // Anyone can sign up
    }
    match /visit_requests/{docId} {
      allow read: if isRole('admin');
      allow create: if true;
    }
    match /exit_intent_offers/{docId} {
      allow read: if isRole('admin');
      allow create: if true;
    }
    match /weekly_updates_signups/{docId} {
      allow read: if isRole('admin');
      allow create: if true;
    }
    match /financial_partner_signups/{docId} {
      allow read: if isRole('admin') || isRole('finance_manager');
      allow create: if true;
    }
     match /prayer_partner_signups/{docId} {
      allow read: if isRole('admin') || isRole('pastoral_care');
      allow create: if true;
    }
    match /volunteer_partner_signups/{docId} {
      allow read: if isRole('admin');
      allow create: if true;
    }

    // Default deny all other reads/writes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
