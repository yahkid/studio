rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is an admin
    function isAdmin() {
      // The admin UID is stored in an environment variable in the app,
      // but for security rules, we list the admin UIDs directly here.
      // Replace 'ADMIN_USER_UID_PLACEHOLDER' with the actual UID from Firebase Auth.
      let adminUIDs = ['ADMIN_USER_UID_PLACEHOLDER'];
      return request.auth != null && request.auth.uid in adminUIDs;
    }

    // --- PUBLIC-READABLE COLLECTIONS ---
    // Anyone can read these collections, but only admins can write to them.
    match /leadership/{leaderId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /published_testimonials/{testimonyId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- USER SUBMISSIONS ---
    // Users must be authenticated to submit forms.
    function isAuthenticated() {
      return request.auth != null;
    }
    
    match /decisions/{decisionId} {
      allow create: if isAuthenticated();
    }
    
    match /lead_magnet_signups/{signupId} {
      allow create: if true; // Open to all visitors
    }
    
    match /visit_requests/{requestId} {
       allow create: if true; // Open to all visitors
    }
    
    match /exit_intent_offers/{offerId} {
       allow create: if true; // Open to all visitors
    }
    
    match /weekly_updates_signups/{signupId} {
       allow create: if true; // Open to all visitors
    }
    
    match /financial_partner_signups/{signupId} {
       allow create: if true; // Open to all visitors
    }
    
    match /prayer_partner_signups/{signupId} {
       allow create: if true; // Open to all visitors
    }
    
    match /volunteer_partner_signups/{signupId} {
       allow create: if true; // Open to all visitors
    }

    // --- USER-SPECIFIC DATA ---
    // Users can only read/write their own data.
    match /user_course_progress/{progressId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.user_id;
    }

    // --- TESTIMONIES WORKFLOW ---
    match /user_testimonies/{testimonyId} {
      // Any authenticated user can create their own testimony.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only an admin can read all testimonies or update the status.
      allow read: if isAdmin();
      allow update: if isAdmin() && request.resource.data.status != resource.data.status;

      // Users cannot delete or update other fields of their own testimony once submitted.
      allow delete: if false;
    }
  }
}
