
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    // For this prototype, we consider any signed-in user an admin.
    // In production, this would check for a custom claim or an 'admins' collection.
    function isAdmin() {
      return isSignedIn();
    }

    // --- PUBLIC-READ, ADMIN-WRITE COLLECTIONS ---
    // Anyone can read these, but only admins can modify them from the dashboard.
    match /sermons/{sermonId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /published_testimonials/{testimonialId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /leadership/{leaderId} {
      allow read: if true;
      allow write: if isAdmin();
    }
     match /resources/{resourceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /blog_posts/{postId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- USER-SUBMITTED DATA ---
    // Users can create their own data, but only admins can read/manage the full list.
    match /decisions/{decisionId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdmin();

      // Subcollection for pastor contact logs
      match /contact_logs/{logId} {
         allow read, create: if isAdmin();
      }
    }
    
    match /user_testimonies/{testimonyId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if isAdmin();
    }
    
    // --- USER-SPECIFIC DATA ---
    // Users can only access their own documents.
    match /user_course_progress/{progressId} {
      allow read, write: if isSignedIn() && resource.data.user_id == request.auth.uid;
    }
    
    match /donations/{donationId} {
      // Authenticated users can create their own donation records.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Admins can read all donations for financial dashboards.
      allow read: if isAdmin();
      // The webhook, acting with server credentials, can update status.
      // For this prototype, we'll allow admin updates as well.
      allow update: if isAdmin();
    }

    // --- OPEN-WRITE COLLECTIONS for FORMS ---
    // Anyone can submit to these forms (e.g., from modals or footer).
    match /visit_requests/{requestId} {
      allow create: if true;
      allow read, delete: if isAdmin();
    }
    match /volunteer_partner_signups/{signupId} {
       allow create: if true;
       allow read, delete: if isAdmin();
    }
    match /lead_magnet_signups/{signupId} {
      allow create: if true;
      allow read: if isAdmin();
    }
    match /weekly_updates_signups/{signupId} {
       allow create: if true;
       allow read: if isAdmin();
    }
     match /prayer_partner_signups/{signupId} {
       allow create: if true;
       allow read: if isAdmin();
    }
     match /exit_intent_offers/{offerId} {
       allow create: if true;
       allow read: if isAdmin();
    }
    
    // --- ADMIN-ONLY COLLECTIONS ---
    match /community_needs/{needId} {
      allow read, create, update: if isAdmin();
    }
  }
}
