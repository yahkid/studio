
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // --- PUBLIC CONTENT (Read for all, Write for Admin/Staff) ---
    // For this prototype, any authenticated user can act as an admin/staff.
    match /courses/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /leadership/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /events/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /sermons/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /published_testimonials/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /resources/{doc=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // --- USER-SPECIFIC DATA (Owned by the user) ---
    // Users can manage their own course progress.
    match /user_course_progress/{progressId} {
      allow read, update: if isAuthenticated() && request.auth.uid == resource.data.user_id;
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.user_id;
    }

    // --- USER SUBMISSIONS (Write by user, Manage by admin) ---
    // Users can create their own testimony. Admins (any auth'd user) can read/update for review.
    match /user_testimonies/{testimonyId} {
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      // Admins can read/update any testimony for the review dashboard.
      allow read, update: if isAuthenticated();
    }

    // Authenticated users can submit a faith decision. Admins can manage them.
    match /decisions/{decisionId} {
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.user_id;
      allow read, update, delete: if isAuthenticated();
    }

    // --- PUBLIC SUBMISSION FORMS (Write by anyone, Manage by admin) ---
    // Anyone can submit these forms. Only admins (any auth'd user) can manage them.
    function canManageSubmissions() {
      return isAuthenticated();
    }

    match /lead_magnet_signups/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /visit_requests/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /exit_intent_offers/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /weekly_updates_signups/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /financial_partner_signups/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /prayer_partner_signups/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
    match /volunteer_partner_signups/{docId} {
      allow create: if true;
      allow read, write: if canManageSubmissions();
    }
  }
}
